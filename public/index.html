<!doctype html>
<html>
  <head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <script src="spotify-web-api.js"></script>
  </head>
  <body>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      var access_token;
      var device_id;
      (async function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var songs = params.json;

        access_token = "BQC7vBV65O6igmhqaoVyP0NM3KdbZ11_JFuYC8Gf-uOPdfkJI9GewXdfJGb4YJOJtD2eDFCthmPKhg0Xmdvac5eMUzxKItDhMLPfqxlBrVQ85SJJKBbFFdYzvavECLM4In_xgj0rXwiiBJQB_gKHMx9fUpYto4FxODm7N0lpqopyt897_e0LUNk0wU04ITeBEY-TnJznPxW2yFAp5MYvFQ29xJ5jFOZlSAVJCrtH92Nyrrs5uE9plHW4PHoUOiqI7fZJHrBVv_9zdpBptcujfrl79lJ4vTM1XqEVnNaaPdBE0SQhB7Rs5E1JnyncfE9bCg";
        device_id = "11a3db0850d0dd5a86983bdfdd1104278b4b9cac";

        var spotifyApi = new SpotifyWebApi();

        spotifyApi.setAccessToken(access_token);

        for (var i = 0; i < songs.length; i++) {
          var element = songs[i];
          console.log(element.id);

          setSong(element.id)
          await sleep(800)
          seekSong(element.start)
          var timeout = parseInt(element.end) >= 0 ? parseInt(element.end) : 500
          await sleep(2000 + timeout)
        }

        spotifyApi.pause({"device_id": device_id});
      })();

      function setSong(id) {
        $.ajax({
          url: 'https://api.spotify.com/v1/me/player/play?device_id=' + device_id,
          data: '{"uris": ["spotify:track:' + id + '"]}',
          type: 'PUT',
          beforeSend: function(xhr) {
              xhr.setRequestHeader("Authorization", "Bearer " + access_token);
              xhr.setRequestHeader("Content-Type", "application/json");
          }
        })
      }

      function seekSong(time) {
        $.ajax({
          url: 'https://api.spotify.com/v1/me/player/seek?position_ms=' + time + '&device_id=' + device_id,
          type: 'PUT',
          beforeSend: function(xhr) {
              xhr.setRequestHeader("Authorization", "Bearer " + access_token);
          }
        })
      }

      function sleep(milliseconds) {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
      }
    </script>
  </body>
</html>
