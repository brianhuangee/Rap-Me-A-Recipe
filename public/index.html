<!doctype html>
<html>
  <head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <script src="spotify-web-api.js"></script>
  </head>
  <body>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      var access_token;
      var device_id;
      (async function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var songs = params.json;

        access_token = "BQAm-J0knYOs5AzSetr-ntogkU8JTD3MS33rlXUfMv5qTx0KM-oLPzHfaLJ-YhnccKC3Lk6lL14vlh9LIxQ8D2DTt6rP3Bo1jf5Q_7bYkMsyhsEGuqdBJcpFrJI14BHP12USV4z9C90dk385AZLi_1k_dx-hsPY0c5RKN0GYSby5EFRnTtRQh5reQhi4RJbe1_r5gE67IZUD0s3gm1Xi11QlpljnfFToecLXn4K_nhuepnWwc2M57z3O4kdeeeiM_f1r5EGXNbb8WvJw9TM4Wp4PwWlviveyiKTZfZ48T5Ljp1Of40fiI4Sell7tQsj5sQ";
        device_id = "028544928f36409f9fea78fc410396306b81dc08";

        var spotifyApi = new SpotifyWebApi();

        spotifyApi.setAccessToken(access_token);

        for (var i = 0; i < songs.length; i++) {
          var element = songs[i];
          console.log(element.id);

          setSong(element.id)
          await sleep(800)
          seekSong(element.start)
          var timeout = parseInt(element.end) >= 0 ? parseInt(element.end) : 500
          await sleep(2000 + timeout)
        }

        spotifyApi.pause({"device_id": device_id});
      })();

      function setSong(id) {
        $.ajax({
          url: 'https://api.spotify.com/v1/me/player/play?device_id=' + device_id,
          data: '{"uris": ["spotify:track:' + id + '"]}',
          type: 'PUT',
          beforeSend: function(xhr) {
              xhr.setRequestHeader("Authorization", "Bearer " + access_token);
              xhr.setRequestHeader("Content-Type", "application/json");
          }
        })
      }

      function seekSong(time) {
        $.ajax({
          url: 'https://api.spotify.com/v1/me/player/seek?position_ms=' + time + '&device_id=' + device_id,
          type: 'PUT',
          beforeSend: function(xhr) {
              xhr.setRequestHeader("Authorization", "Bearer " + access_token);
          }
        })
      }

      function sleep(milliseconds) {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
      }
    </script>
  </body>
</html>
